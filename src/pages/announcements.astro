---
import PublicLayout from "@layouts/PublicLayout.astro";
import { createClient } from "@supabase/supabase-js";

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

// Fetch published announcements
const { data, error } = await supabase
  .from("announcements")
  .select("*")
  .eq("is_published", true)
  .is("deleted_at", null)
  .order("created_at", { ascending: false });

const announcements = data ?? [];

// Separate featured announcement
const featured = announcements.find(a => a.is_featured) ?? null;
const others = announcements.filter(a => !a.is_featured);

// Helper: format date safely
const formatDate = (date) =>
  new Date(date).toLocaleDateString("en-IN", {
    day: "2-digit",
    month: "short",
    year: "numeric"
  });

// Helper: create excerpt
const excerpt = (text, length = 200) => {
  if (!text) return "";
  return text.length > length ? text.slice(0, length) + "..." : text;
};
---

<PublicLayout
  title="Announcements"
  description="Latest parish announcements, feast-day updates, catechism reminders, and official notices from St. Teresa of Kolkata Church, Paldane."
>

  <!-- HERO -->
  <section class="relative min-h-[55vh] flex items-center justify-center overflow-hidden pt-28">
    <div class="absolute inset-0 bg-gradient-to-br from-charcoal-950 via-charcoal-900 to-primary-900"></div>
    <div class="absolute inset-0 bg-black/35"></div>

    <div class="relative z-10 max-w-5xl px-6 text-center">
      <div class="inline-flex items-center gap-2 px-5 py-2 rounded-full bg-white/10 border border-white/20 shadow-sm backdrop-blur mb-6">
        <span class="w-2 h-2 rounded-full bg-primary-400"></span>
        <span class="text-sm font-medium text-white/90">
          Parish Updates
        </span>
      </div>

      <h1 class="font-serif text-5xl md:text-7xl font-bold text-white mb-6">
        Announcements
      </h1>

      <div class="w-24 h-[2px] bg-white mx-auto mb-6 rounded-full"></div>

      <p class="text-white/85 text-lg md:text-xl leading-relaxed max-w-3xl mx-auto">
        Stay informed with official parish notices, feast-day updates, and important community messages.
      </p>
    </div>
  </section>

  <!-- MAIN CONTENT -->
  <section class="py-20 bg-white">
    <div class="container mx-auto px-4 max-w-6xl">

      <!-- NOTICE BOARD INTRO -->
      <div class="rounded-3xl border border-gray-200 bg-gray-50 p-10 shadow-sm mb-12">
        <h2 class="font-serif text-4xl font-bold text-charcoal-900 mb-4">
          Parish Notice Board
        </h2>

        <p class="text-charcoal-700 leading-relaxed text-lg max-w-4xl">
          All official parish announcements are published here by the parish office.
          Please check this section regularly for important updates.
        </p>
      </div>

      <!-- FEATURED ANNOUNCEMENT -->
      {featured && (
        <article class="rounded-3xl border border-primary-200 bg-gradient-to-br from-primary-50 to-white shadow-sm hover:shadow-md transition overflow-hidden mb-12">
          <div class="p-10">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-5">
              <span class="px-4 py-1 rounded-full text-sm bg-primary-600 text-white font-semibold shadow-sm">
                ðŸ“Œ Featured Announcement
              </span>

              <span class="text-sm text-charcoal-500">
                Published: {formatDate(featured.created_at)}
              </span>
            </div>

            <h3 class="font-serif text-4xl font-bold text-charcoal-900 mb-4">
              <a href={`/announcements/${featured.slug}`} class="hover:text-primary-600 transition">
                {featured.title}
              </a>
            </h3>

            <p class="text-charcoal-700 text-lg leading-relaxed whitespace-pre-line">
              {excerpt(featured.content, 350)}
            </p>

            <a
              href={`/announcements/${featured.slug}`}
              class="mt-6 inline-block text-primary-600 font-semibold hover:underline"
            >
              Read Full Announcement â†’
            </a>
          </div>
        </article>
      )}

      <!-- ANNOUNCEMENTS LIST -->
      {others.length > 0 ? (
        <div class="grid gap-8">
          {others.map((item) => (
            <article class="rounded-3xl border border-gray-200 bg-white shadow-sm hover:shadow-md transition overflow-hidden">
              <div class="p-10">

                <div class="text-sm text-charcoal-500 mb-4">
                  Published: {formatDate(item.created_at)}
                </div>

                <h3 class="font-serif text-3xl font-bold text-charcoal-900 mb-3">
                  <a href={`/announcements/${item.slug}`} class="hover:text-primary-600 transition">
                    {item.title}
                  </a>
                </h3>

                <p class="text-charcoal-700 text-lg leading-relaxed line-clamp-3 whitespace-pre-line">
                  {excerpt(item.content)}
                </p>

                <a
                  href={`/announcements/${item.slug}`}
                  class="mt-6 inline-block text-primary-600 font-semibold hover:underline"
                >
                  Read More â†’
                </a>

              </div>
            </article>
          ))}
        </div>
      ) : (
        <div class="text-center py-20 text-charcoal-500">
          No announcements published yet.
        </div>
      )}

      <!-- FOOTNOTE -->
      <div class="mt-16 rounded-3xl border border-gray-200 bg-gray-50 p-10 shadow-sm">
        <h3 class="font-serif text-3xl font-bold text-charcoal-900 mb-4">
          Important Note
        </h3>

        <p class="text-charcoal-700 leading-relaxed text-lg max-w-5xl">
          For major feast days and special events, additional notices may also be shared on the parish notice board
          and official communication channels.
        </p>
      </div>

    </div>
  </section>

</PublicLayout>
