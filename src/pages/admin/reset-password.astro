---
import AdminLayout from "@layouts/AdminLayout.astro";

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
---

<AdminLayout title="Set New Password">

  <section class="min-h-screen flex items-center justify-center px-4">

    <div class="w-full max-w-md bg-white text-charcoal-900 rounded-3xl shadow-2xl p-10">

      <div class="flex flex-col items-center mb-8">
        <img src="/images/logo.png" class="h-16 w-16 mb-4 rounded-full shadow-md" />
        <h1 class="font-serif text-2xl font-semibold text-center">
          Set New Password
        </h1>
        <p class="text-sm text-gray-500 mt-1">
          Enter your new password
        </p>
      </div>

      <form id="updateForm" class="space-y-5">

        <!-- New Password -->
        <div class="relative">
          <input
            id="password"
            type="password"
            placeholder="New Password"
            required
            class="w-full px-5 py-3 rounded-xl border border-gray-300 text-charcoal-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-600 transition"
          />
          <button
            type="button"
            id="togglePassword"
            class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-700 text-sm"
          >
            Show
          </button>
        </div>

        <!-- Confirm Password -->
        <div class="relative">
          <input
            id="confirmPassword"
            type="password"
            placeholder="Confirm Password"
            required
            class="w-full px-5 py-3 rounded-xl border border-gray-300 text-charcoal-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-600 transition"
          />
          <button
            type="button"
            id="toggleConfirm"
            class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-700 text-sm"
          >
            Show
          </button>
        </div>

        <button
          id="submitBtn"
          type="submit"
          class="w-full py-3 rounded-xl bg-primary-600 text-white font-semibold hover:bg-primary-700 transition shadow-md"
        >
          Update Password
        </button>

        <p id="message" class="text-center text-sm mt-2"></p>

      </form>

    </div>

  </section>

  <script type="module" define:vars={{ supabaseUrl, supabaseAnonKey }}>
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    const form = document.getElementById("updateForm");
    const message = document.getElementById("message");
    const button = document.getElementById("submitBtn");

    const passwordInput = document.getElementById("password");
    const confirmInput = document.getElementById("confirmPassword");
    const togglePassword = document.getElementById("togglePassword");
    const toggleConfirm = document.getElementById("toggleConfirm");

    // Toggle password visibility
    togglePassword?.addEventListener("click", () => {
      passwordInput.type =
        passwordInput.type === "password" ? "text" : "password";
      togglePassword.textContent =
        passwordInput.type === "password" ? "Show" : "Hide";
    });

    toggleConfirm?.addEventListener("click", () => {
      confirmInput.type =
        confirmInput.type === "password" ? "text" : "password";
      toggleConfirm.textContent =
        confirmInput.type === "password" ? "Show" : "Hide";
    });

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const password = passwordInput.value;
      const confirmPassword = confirmInput.value;

      if (password.length < 6) {
        message.textContent = "Password must be at least 6 characters.";
        message.className = "text-red-500 text-sm text-center mt-3";
        return;
      }

      if (password !== confirmPassword) {
        message.textContent = "Passwords do not match.";
        message.className = "text-red-500 text-sm text-center mt-3";
        return;
      }

      button.disabled = true;
      message.textContent = "Updating password...";
      message.className = "text-blue-500 text-sm text-center mt-3";

      const { error } = await supabase.auth.updateUser({
        password: password,
      });

      if (error) {
        message.textContent = error.message;
        message.className = "text-red-500 text-sm text-center mt-3";
        button.disabled = false;
      } else {
        message.textContent = "Password updated successfully!";
        message.className = "text-green-600 text-sm text-center mt-3";

        setTimeout(() => {
          window.location.href = "/admin/login";
        }, 1500);
      }
    });
  </script>

</AdminLayout>
