---
import AdminLayout from "@layouts/AdminLayout.astro";

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
---

<AdminLayout title="Dashboard">

  <section class="min-h-screen flex items-center justify-center px-6">

    <div class="w-full max-w-3xl bg-white/95 backdrop-blur rounded-3xl shadow-2xl p-10 text-charcoal-900">

      <div class="flex justify-between items-center mb-8">
        <div>
          <h1 class="font-serif text-3xl font-semibold">
            Admin Dashboard
          </h1>
          <p id="roleText" class="text-sm text-gray-500 mt-1">
            Checking permissions...
          </p>
        </div>

        <button
          id="logoutBtn"
          class="px-5 py-2 rounded-xl bg-red-500 text-white font-semibold hover:bg-red-600 transition hidden"
        >
          Logout
        </button>
      </div>

      <div id="contentArea" class="grid md:grid-cols-2 gap-6 opacity-0 transition">

        <a href="/admin/announcements"
           class="p-6 rounded-2xl bg-gray-100 hover:bg-primary-100 transition shadow-md">
          <h2 class="font-semibold text-lg mb-2">Announcements</h2>
          <p class="text-sm text-gray-600">
            Add, edit and publish parish announcements.
          </p>
        </a>

        <a href="/admin/mass-timings"
           class="p-6 rounded-2xl bg-gray-100 hover:bg-primary-100 transition shadow-md">
          <h2 class="font-semibold text-lg mb-2">Mass Timings</h2>
          <p class="text-sm text-gray-600">
            Manage regular and feast-day Mass timings.
          </p>
        </a>

        <a href="/admin/clergy"
           class="p-6 rounded-2xl bg-gray-100 hover:bg-primary-100 transition shadow-md">
          <h2 class="font-semibold text-lg mb-2">Clergy</h2>
          <p class="text-sm text-gray-600">
            Update priests, bio and profile images.
          </p>
        </a>

        <a href="/admin/pages"
           class="p-6 rounded-2xl bg-gray-100 hover:bg-primary-100 transition shadow-md">
          <h2 class="font-semibold text-lg mb-2">Static Pages</h2>
          <p class="text-sm text-gray-600">
            Edit website page content.
          </p>
        </a>

      </div>

    </div>

  </section>

  <script type="module" define:vars={{ supabaseUrl, supabaseAnonKey }}>
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    const logoutBtn = document.getElementById("logoutBtn");
    const roleText = document.getElementById("roleText");
    const contentArea = document.getElementById("contentArea");

    // Check session
    const { data: { session } } = await supabase.auth.getSession();

    if (!session) {
      window.location.href = "/admin/login";
    } else {
      logoutBtn.classList.remove("hidden");
      contentArea.classList.remove("opacity-0");

      // Fetch role
      const { data: roleData } = await supabase
        .from("user_roles")
        .select("role")
        .eq("id", session.user.id)
        .single();

      roleText.textContent =
        roleData?.role === "super_admin"
          ? "Super Administrator"
          : "Editor";
    }

    logoutBtn?.addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "/admin/login";
    });
  </script>

</AdminLayout>
