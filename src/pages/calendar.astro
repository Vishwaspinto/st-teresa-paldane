---
import PublicLayout from "@layouts/PublicLayout.astro";
---

<PublicLayout
  title="Parish Calendar"
  description="Parish calendar of St. Teresa of Kolkata Church, Paldane. View liturgical feast days, parish celebrations, and important upcoming events."
>
  <!-- HERO -->
  <section class="relative min-h-[55vh] flex items-center justify-center overflow-hidden pt-28">
    <div class="absolute inset-0 bg-gradient-to-br from-charcoal-950 via-charcoal-900 to-primary-900"></div>
    <div class="absolute inset-0 bg-black/35"></div>

    <div class="relative z-10 max-w-5xl px-6 text-center">
      <div class="inline-flex items-center gap-2 px-5 py-2 rounded-full bg-white/10 border border-white/20 shadow-sm backdrop-blur mb-6">
        <span class="w-2 h-2 rounded-full bg-primary-400"></span>
        <span class="text-sm font-medium text-white/90">
          Parish Events & Feast Days
        </span>
      </div>

      <h1 class="font-serif text-5xl md:text-7xl font-bold text-white mb-6">
        Parish Calendar
      </h1>

      <div class="w-24 h-[2px] bg-white mx-auto mb-6 rounded-full"></div>

      <p class="text-white/85 text-lg md:text-xl leading-relaxed max-w-3xl mx-auto">
        View liturgical feast days, parish celebrations, Mass events, catechism schedules,
        and important parish dates.
      </p>
    </div>
  </section>

  <!-- CALENDAR -->
  <section class="py-20 bg-white">
    <div class="container mx-auto px-4 max-w-6xl">
      <div class="rounded-3xl border border-gray-200 bg-gray-50 shadow-sm p-6 md:p-10">

        <!-- HEADER -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 mb-8">
          <div>
            <h2 id="monthTitle" class="font-serif text-3xl font-bold text-charcoal-900"></h2>
            <p class="text-charcoal-600 text-sm mt-1">
              Liturgical feast days and parish events are displayed below.
            </p>
          </div>

          <div class="flex gap-3">
            <button
              id="prevMonth"
              aria-label="Previous Month"
              class="px-5 py-3 rounded-full bg-white border border-gray-200 shadow-sm hover:shadow-md transition text-charcoal-900 font-medium"
            >
              ← Prev
            </button>

            <button
              id="todayBtn"
              aria-label="Go to Current Month"
              class="px-5 py-3 rounded-full bg-primary-600 text-white shadow-md hover:bg-primary-700 transition font-semibold"
            >
              Today
            </button>

            <button
              id="nextMonth"
              aria-label="Next Month"
              class="px-5 py-3 rounded-full bg-white border border-gray-200 shadow-sm hover:shadow-md transition text-charcoal-900 font-medium"
            >
              Next →
            </button>
          </div>
        </div>

        <!-- WEEKDAYS -->
        <div class="grid grid-cols-7 text-center text-xs font-semibold text-charcoal-500 uppercase tracking-wide mb-4">
          <div>Sun</div>
          <div>Mon</div>
          <div>Tue</div>
          <div>Wed</div>
          <div>Thu</div>
          <div>Fri</div>
          <div>Sat</div>
        </div>

        <!-- GRID -->
        <div id="calendarGrid" class="grid grid-cols-7 gap-3 min-h-[300px]"></div>

        <!-- LEGEND -->
        <div class="mt-10 flex flex-wrap gap-4 text-sm text-charcoal-700">
          <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-primary-600"></span>
            Liturgical Feast
          </div>

          <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-amber-500"></span>
            Parish Event
          </div>

          <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-charcoal-700"></span>
            Ward / Group Duty
          </div>
        </div>

      </div>
    </div>
  </section>
</PublicLayout>

<script>
  const monthTitle = document.getElementById("monthTitle");
  const calendarGrid = document.getElementById("calendarGrid");

  const prevBtn = document.getElementById("prevMonth");
  const nextBtn = document.getElementById("nextMonth");
  const todayBtn = document.getElementById("todayBtn");

  let currentDate = new Date();
  let feastDays = [];
  let manualEvents = [];

  async function fetchFeasts(year, month) {
    try {
      const res = await fetch(`/api/liturgical-calendar?year=${year}&month=${month + 1}`);
      const data = await res.json();
      feastDays = Array.isArray(data) ? data : (data.feasts || data.data || []);
    } catch {
      feastDays = [];
    }
  }

  async function fetchManualEvents() {
    try {
      const res = await fetch("/.netlify/functions/manual-events");
      manualEvents = await res.json();
    } catch {
      manualEvents = [];
    }
  }

  function formatMonthTitle(date) {
    return date.toLocaleDateString("en-US", {
      month: "long",
      year: "numeric",
    });
  }

  function isToday(day, month, year) {
    const t = new Date();
    return (
      day === t.getDate() &&
      month === t.getMonth() &&
      year === t.getFullYear()
    );
  }

  function getFeastForDate(dateStr) {
    return feastDays?.find?.((f) => f.date === dateStr);
  }

  function getManualEventsForDate(dateStr) {
    return manualEvents?.filter?.((e) => e.date === dateStr) || [];
  }

  function renderCalendar(date) {
    if (!calendarGrid) return;

    calendarGrid.innerHTML = "";
    monthTitle.textContent = formatMonthTitle(date);

    const year = date.getFullYear();
    const month = date.getMonth();

    const firstDay = new Date(year, month, 1);
    const startingDayIndex = firstDay.getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    for (let i = 0; i < startingDayIndex; i++) {
      const empty = document.createElement("div");
      empty.className = "h-28";
      calendarGrid.appendChild(empty);
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;

      const feast = getFeastForDate(dateStr);
      const events = getManualEventsForDate(dateStr);

      const card = document.createElement("div");
      card.className =
        "h-28 rounded-2xl bg-white border border-gray-200 shadow-sm hover:shadow-md transition p-3 flex flex-col justify-between";

      if (isToday(day, month, year)) {
        card.classList.add("ring-2", "ring-primary-600");
      }

      const dayNum = document.createElement("div");
      dayNum.className = "text-sm font-semibold text-charcoal-900";
      dayNum.textContent = day;

      const tags = document.createElement("div");
      tags.className = "space-y-1 text-xs";

      if (feast?.title) {
        const feastTag = document.createElement("div");
        feastTag.className =
          "inline-block px-2 py-1 rounded-full bg-primary-600 text-white font-medium truncate";
        feastTag.textContent = feast.title;
        tags.appendChild(feastTag);
      }

      events.forEach((ev) => {
        const tag = document.createElement("div");
        tag.className =
          "inline-block px-2 py-1 rounded-full bg-amber-500 text-white font-medium truncate";
        tag.textContent = ev.title || "Event";
        tags.appendChild(tag);
      });

      card.appendChild(dayNum);
      card.appendChild(tags);
      calendarGrid.appendChild(card);
    }
  }

  async function loadMonth(date) {
    calendarGrid.innerHTML =
      "<div class='col-span-7 text-center text-sm text-charcoal-500 py-10'>Loading calendar...</div>";

    await fetchFeasts(date.getFullYear(), date.getMonth());
    await fetchManualEvents();
    renderCalendar(date);
  }

  prevBtn?.addEventListener("click", async () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    await loadMonth(currentDate);
  });

  nextBtn?.addEventListener("click", async () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    await loadMonth(currentDate);
  });

  todayBtn?.addEventListener("click", async () => {
    currentDate = new Date();
    await loadMonth(currentDate);
  });

  loadMonth(currentDate);
</script>
